name: Build Vaultwarden Multi-Arch Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DOCKER_REPO: server

    outputs:
      vaultwarden_version: ${{ steps.get_latest_version.outputs.VAULTWARDEN_VERSION_OUTPUT }}
      docker_repo_name: ${{ env.DOCKER_REPO }}
      build_job_status: ${{ job.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Get Vaultwarden Latest Release Version
        id: get_latest_version
        run: |
          LATEST_RELEASE_INFO=$(curl -sL "https://api.github.com/repos/dani-garcia/vaultwarden/releases/latest")
          VERSION=$(echo "$LATEST_RELEASE_INFO" | jq -r '.tag_name')

          echo "ä» GitHub API æå–åˆ°çš„æœ€æ–°å‘å¸ƒç‰ˆæœ¬å· (ç”¨äº Docker æ ‡ç­¾): $VERSION"

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "é”™è¯¯ï¼šæ— æ³•ä» GitHub API è·å–åˆ° Vaultwarden çš„æœ€æ–°å‘å¸ƒç‰ˆæœ¬å·ã€‚æ„å»ºå°†ç«‹å³ç»ˆæ­¢ã€‚"
            echo "API å“åº”: $LATEST_RELEASE_INFO"
            exit 1
          fi

          echo "VAULTWARDEN_VERSION=$VERSION" >> $GITHUB_ENV
          echo "VAULTWARDEN_VERSION_OUTPUT=$VERSION" >> $GITHUB_OUTPUT

      - name: Display Obtained Version
        run: |
          echo "--- è·å–åˆ°çš„ Vaultwarden ç‰ˆæœ¬å· ---"
          echo "ç‰ˆæœ¬å·: ${{ env.VAULTWARDEN_VERSION }}"
          echo "-----------------------------------"

      - name: Build and Push Multi-Arch Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:latest
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ env.VAULTWARDEN_VERSION }}
            ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ env.VAULTWARDEN_VERSION }}-${{ secrets.DOCKER_USERNAME }}
          build-args: |
            VW_VERSION=${{ env.VAULTWARDEN_VERSION }}

  telegram-notification:
    needs: build
    if: always()
    runs-on: ubuntu-latest
    env:
      VAULTWARDEN_VERSION: ${{ needs.build.outputs.vaultwarden_version }}
      DOCKER_REPO: ${{ needs.build.outputs.docker_repo_name }}
      BUILD_STATUS: ${{ needs.build.outputs.build_job_status }}

    steps:
      - name: Send Telegram Notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            ${{ (env.BUILD_STATUS == 'success' && 'âœ… Vaultwarden å¤šæ¶æ„ Docker é•œåƒæ„å»ºæˆåŠŸï¼') || '' }}
            ${{ (env.BUILD_STATUS == 'failure' && 'âŒ Vaultwarden å¤šæ¶æ„ Docker é•œåƒæ„å»ºå¤±è´¥ï¼') || '' }}
            ${{ (env.BUILD_STATUS == 'cancelled' && 'ğŸš« Vaultwarden å¤šæ¶æ„ Docker é•œåƒæ„å»ºå·²å–æ¶ˆï¼') || '' }}

            ä»“åº“: ${{ github.repository }}
            åˆ†æ”¯: ${{ github.ref_name }}
            æäº¤: ${{ github.sha }}
            ç‰ˆæœ¬: ${{ env.VAULTWARDEN_VERSION }}
            Docker Hub é•œåƒ: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ env.VAULTWARDEN_VERSION }}
            å·¥ä½œæµé“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          disable_web_page_preview: true
